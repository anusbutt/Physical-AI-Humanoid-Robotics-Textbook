name: Deploy Backend to HF Spaces

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
    steps:
      - name: Checkout GitHub repo
        uses: actions/checkout@v4

      - name: Push backend to HF Space
        run: |
          # Configure git
          git config --global user.email "ci@github.com"
          git config --global user.name "GitHub Actions"

          # Clone HF Space repo (public read)
          git clone https://huggingface.co/spaces/anusbutt/rag-chatbot hf-space

          # Clear old files (keep .git directory)
          cd hf-space
          find . -maxdepth 1 -not -name '.git' -not -name '.' -exec rm -rf {} +

          # Copy backend files
          cp ../backend/Dockerfile .
          cp ../backend/requirements.txt .
          cp -r ../backend/app ./app

          # Commit
          git add .
          git commit -m "Deploy from GitHub Actions - $(date -u +%Y-%m-%dT%H:%M:%SZ)" || echo "No changes"

          # Push directly with token in URL (bypass remote)
          git push "https://anusbutt:${HF_TOKEN}@huggingface.co/spaces/anusbutt/rag-chatbot" main
