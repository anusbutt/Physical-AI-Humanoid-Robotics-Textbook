name: Deploy Backend to HF Spaces

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout GitHub repo
        uses: actions/checkout@v4

      - name: Install huggingface_hub
        run: pip install huggingface_hub

      - name: Push backend to HF Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          # Configure git
          git config --global user.email "ci@github.com"
          git config --global user.name "GitHub Actions"

          # Login to HF using the CLI (sets up proper auth)
          huggingface-cli login --token $HF_TOKEN --add-to-git-credential

          # Clone HF Space repo
          git clone https://huggingface.co/spaces/anusbutt/rag-chatbot hf-space

          # Clear old files (keep .git directory)
          cd hf-space
          find . -maxdepth 1 -not -name '.git' -not -name '.' -exec rm -rf {} +

          # Copy backend files
          cp ../backend/Dockerfile .
          cp ../backend/requirements.txt .
          cp -r ../backend/app ./app

          # Push to HF Space
          git add .
          git commit -m "Deploy from GitHub Actions - $(date -u +%Y-%m-%dT%H:%M:%SZ)" || echo "No changes"
          git push origin main
