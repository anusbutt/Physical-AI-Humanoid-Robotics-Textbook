name: Deploy Backend to HF Spaces

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
    steps:
      - name: Checkout GitHub repo
        uses: actions/checkout@v4

      - name: Push backend to HF Space
        run: |
          # Configure git
          git config --global user.email "ci@github.com"
          git config --global user.name "GitHub Actions"

          # Create a git askpass helper that returns our token
          echo '#!/bin/sh' > /tmp/askpass.sh
          echo 'echo $HF_TOKEN' >> /tmp/askpass.sh
          chmod +x /tmp/askpass.sh
          export GIT_ASKPASS=/tmp/askpass.sh

          # Clone HF Space repo (public read, no auth needed)
          git clone https://huggingface.co/spaces/anusbutt/rag-chatbot hf-space

          # Clear old files (keep .git directory)
          cd hf-space
          find . -maxdepth 1 -not -name '.git' -not -name '.' -exec rm -rf {} +

          # Copy backend files
          cp ../backend/Dockerfile .
          cp ../backend/requirements.txt .
          cp -r ../backend/app ./app

          # Set remote with username (GIT_ASKPASS provides the password)
          git remote set-url origin https://anusbutt@huggingface.co/spaces/anusbutt/rag-chatbot

          # Push to HF Space
          git add .
          git commit -m "Deploy from GitHub Actions - $(date -u +%Y-%m-%dT%H:%M:%SZ)" || echo "No changes"
          git push origin main
